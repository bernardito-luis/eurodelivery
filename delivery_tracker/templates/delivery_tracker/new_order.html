{% extends 'delivery_tracker/base.html' %}
{% load staticfiles %}

{% block content %}
    <div class="container">
        <div class="row top-offset-20">
            <div class="col-md-offset-8 col-md-3">
                <b>Welcome{% if user.first_name %}, {{ user.first_name }}{% endif %}!</b>
            </div>
            <div class="col-md-1">
                <b><a href="{% url 'logout' %}">Logout</a></b>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 top-offset-20">
                <div class="header_stripe">
                    <a href="{% url 'cabinet' %}">
                        <span class="glyphicon glyphicon-heart" aria-hidden="true" style="color: white"></span> Главная
                    </a> -
                    <a href="{% url 'orders_and_bills' %}">Заказы и счета</a> -
                    <a href="{% url 'new_order' %}">Создать новый заказ</a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-offset-4 col-sm-offset-4 col-md-4 col-sm-4">
                {% for msg in messages %}
                    <b>{{ msg }}</b><br/>
                {% endfor %}

            </div>
        </div>
        <div class="row top-offset-20">
            <div class="col-md-12">
                <form id="id_order_form" action="{% url 'new_order' %}" method="post" class="form-horizontal">
                    {% csrf_token %}

                    {{ form.shipping_cost.errors }}
                    <div class="form-group">
                        <label for="id_shipping_cost" class="control-label col-sm-2">Стоимость доставки*</label>
                        <div class="col-sm-5">
                            <input id="id_shipping_cost" type="text" name="shipping_cost" value="{{ form.shipping_cost.value }}" class="form-control calc_total_sum" />
                        </div>
                    </div>
                    {{ form.coupon.errors }}
                    <div class="form-group">
                        <label for="id_coupon" class="control-label col-sm-2">Код скидки на наши услуги</label>
                        <div class="col-sm-5">
                            <input id="id_coupon" type="text" name="coupon" value="" class="form-control" />
                        </div>
                    </div>
                    {{ form.discount.errors }}
                    <div class="form-group">
                        <label for="id_discount" class="control-label col-sm-2">Размер скидки на наши услуги*</label>
                        <div class="col-sm-5">
                            <input id="id_discount" type="text" name="discount" value="{{ form.discount.value }}" class="form-control calc_total_sum" />
                        </div>
                    </div>
                    {{ form.user_comment.errors }}
                    <div class="form-group">
                        <label for="id_user_comment" class="control-label col-sm-2">Комментарий</label>
                        <div class="col-sm-5">
                            <input id="id_user_comment" type="text" name="user_comment" value="{{ form.user_comment.value }}" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_current_fee" class="control-label col-sm-2">Текущий тариф</label>
                        <div class="col-sm-5">
                            <input id="id_current_fee" type="text" name="current_fee" value="{{ current_fee }}" readonly="1" class="form-control" />
                        </div>
                    </div>
                    <input id="id_max_prod_num" name="max_prod_num" type="hidden" value="1" />

                    <div class="row">
                        <div class="col-md-1">Магазин</div>
                        <div class="col-md-1">Ссылка на товар*</div>
                        <div class="col-md-1">Артикул</div>
                        <div class="col-md-1">Название товара</div>
                        <div class="col-md-1">Цвет*</div>
                        <div class="col-md-1">Размер*</div>
                        <div class="col-md-1">Количество*</div>
                        <div class="col-md-1">Цена*</div>
                        <div class="col-md-1">Код скидки</div>
                        <div class="col-md-1">Сумма скидки*</div>
                        <div class="col-md-1">Сумма*</div>
                        <div class="col-md-1">Примечание</div>
                    </div>
                    <div id="id_product_list">
                    <div id="id_product_row_1" class="row">
                        <div class="col-sm-1">
                            <input id="id_shop_link_1" type="text" name="shop_link_1" class="form-control" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_product_link_1" type="text" name="product_link_1" class="form-control" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_vendor_code_1" type="text" name="vendor_code_1" class="form-control" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_name_1" type="text" name="name_1" class="form-control" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_color_1" type="text" name="color_1" class="form-control" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_size_1" type="text" name="size_1" class="form-control" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_quantity_1" type="text" name="quantity_1" class="form-control calc_sum" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_price_1" type="text" name="price_1" class="form-control calc_sum" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_discount_code_1" type="text" name="discount_code_1" class="form-control" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_discount_in_shop_1" type="text" name="discount_in_shop_1" value="0" class="form-control calc_sum" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_sum_1" type="text" name="sum_1" readonly="1" class="form-control product_sum" />
                        </div>
                        <div class="col-sm-1">
                            <input id="id_note_1" type="text" name="note_1" class="form-control" style="float: left;" />
                            <button id="id_delete_product_1" type="button" class="btn btn-default delete_product">X</button>
                        </div>
                    </div>
                    </div>
                    <div class="row top-offset-20 ">
                        <div class="col-md-offset-9 col-md-2">
                            <button type="button" id="id_add_product" class="btn btn-default">+ Добавить</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_order_total" class="control-label col-sm-3">Итого сумма Вашего заказа:</label>
                        <div class="col-sm-2">
                            <input id="id_order_total" type="text" disabled value="" class="form-control" />
                        </div>
                    </div>
                    <div class="row form-group">
                        <div class="col-md-offset-2 col-md-1">
                            <button type="submit" name="new_order" class="btn btn-default">Заказать</button>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" name="new_order_draft" class="btn btn-default">Сохранить как черновик</button>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" name="new_order_cancel" class="btn btn-default">Отмена</button>
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>

{% endblock %}

{% block script %}
<script>
    var current_prod_qty = 1;

    function calc_sum() {
        var product_id = this.id.substring(this.id.lastIndexOf("_")+1);
        var qty_id = '#id_quantity_' + product_id;
        var price_id = '#id_price_' + product_id;
        var discount_in_shop_id = '#id_discount_in_shop_' + product_id;
        var sum_id = '#id_sum_' + product_id;
        if ($(qty_id).val() !== undefined && $(qty_id).val() !== '' &&
                $(price_id).val() !== undefined && $(price_id).val() !== '' &&
                $(discount_in_shop_id).val() !== undefined && $(discount_in_shop_id).val() !== ''
            ) {
            var qty = parseFloat($(qty_id).val(), 10);
            var price = parseFloat($(price_id).val(), 10);
            var discount_in_shop = parseFloat($(discount_in_shop_id).val(), 10);
            if (!isNaN(qty) && !isNaN(price) && !isNaN(discount_in_shop)) {
                var sum = qty*price - discount_in_shop;
                if (sum > 0) {
                    $(sum_id).attr('value', sum);
                    calc_total_sum();
                } else {
                    $(sum_id).attr('value', 0);
                }
            }
            else {
                $(sum_id).attr('value', '');
            }
        }
        else {
            $(sum_id).attr('value', '');
        }
    }
    $(".calc_sum").on('input', calc_sum);
    $(".calc_total_sum").on('input', calc_total_sum);

    function delete_product() {
        var product_id = this.id.substring(this.id.lastIndexOf("_")+1);
        $('#id_product_row_'+product_id).remove();
        calc_total_sum();
    }
    $(".delete_product").click(delete_product);

    function calc_total_sum() {
        var total_sum = 0;
        $(".product_sum").each(function () {
            if (!isNaN($(this).val()) && $(this).val() !== '') {
                total_sum += parseFloat($(this).val(), 10);
            }
        });
        if ($('#id_shipping_cost').val() !== '') {
            total_sum += parseFloat($('#id_shipping_cost').val(), 10);
        }
        if ($('#id_discount').val() !== '') {
            total_sum -= parseFloat($('#id_discount').val(), 10);
        }
        if ($('#id_current_fee').val() !== '') {
            total_sum += parseFloat($('#id_current_fee').val(), 10);
        }
        if (total_sum < 0) {
            total_sum = 0;
        }
        $("#id_order_total").attr('value', total_sum);
    }

    $("#id_add_product").click(function () {
        current_prod_qty++;
        $("#id_max_prod_num").attr('value', current_prod_qty);
        var new_product = `
            <div id="id_product_row_(product_num)" class="row top-offset-5">
                <div class="col-sm-1">
                    <input id="id_shop_link_(product_num)" type="text" name="shop_link_(product_num)" class="form-control" />
                </div>
                <div class="col-sm-1">
                    <input id="id_product_link_(product_num)" type="text" name="product_link_(product_num)" class="form-control" />
                </div>
                <div class="col-sm-1">
                    <input id="id_vendor_code_(product_num)" type="text" name="vendor_code_(product_num)" class="form-control" />
                </div>
                <div class="col-sm-1">
                    <input id="id_name_(product_num)" type="text" name="name_(product_num)" class="form-control" />
                </div>
                <div class="col-sm-1">
                    <input id="id_color_(product_num)" type="text" name="color_(product_num)" class="form-control" />
                </div>
                <div class="col-sm-1">
                    <input id="id_size_(product_num)" type="text" name="size_(product_num)" class="form-control" />
                </div>
                <div class="col-sm-1">
                    <input id="id_quantity_(product_num)" type="text" name="quantity_(product_num)" class="form-control calc_sum" />
                </div>
                <div class="col-sm-1">
                    <input id="id_price_(product_num)" type="text" name="price_(product_num)" class="form-control calc_sum" />
                </div>
                <div class="col-sm-1">
                    <input id="id_discount_code_(product_num)" type="text" name="discount_code_(product_num)" class="form-control" />
                </div>
                <div class="col-sm-1">
                    <input id="id_discount_in_shop_(product_num)" type="text" name="discount_in_shop_(product_num)" value="0" class="form-control calc_sum" />
                </div>
                <div class="col-sm-1">
                    <input id="id_sum_(product_num)" type="text" name="sum_(product_num)" readonly="1" class="form-control product_sum" />
                </div>
                <div class="col-sm-1">
                    <input id="id_note_(product_num)" type="text" name="note_(product_num)" class="form-control" style="float: left;" />
                    <button id="id_delete_product_(product_num)"type="button" class="btn btn-default delete_product">X</button>
                </div>
            </div>
        `;
        new_product = new_product.replace(/\(product_num\)/g, current_prod_qty);
        $("#id_product_list").append(new_product);

        $(".calc_sum").on('input', calc_sum);
        $(".delete_product").click(delete_product);

    });

</script>
{% endblock %}
